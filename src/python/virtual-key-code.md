# python 开发中判断键盘事件的坑点 - 虚拟键码

[toc]
![虚拟键码示意图](../assets/cover/virtual-key-code.png)

## 背景描述

最近，在 Trae 的帮助下，我正在开发一个 Python 项目，这个项目需要判断用户是否按下了特定的键。
我的技术背景是 Java 和 web 前端开发，所以我对 Python 相对比较陌生。跟着 Trae 的指导，我成功地完成了大部分功能，也能加深对 python 的理解。
但是，在开发过程中，我遇到了一个问题，那就是无法获取到用户按下的键的字符。困惑点在于，可以捕捉到一些特定的键，如`Ctrl`、`Shift`、`Alt`等，但是无法捕捉到用户输入的字符。折腾了很久，才发现遇到了一个叫`虚拟键码`的问题。

## 一、什么是虚拟键码？

**虚拟键码（Virtual-Key Code）** 是操作系统为每个物理按键分配的一个固定编号。例如：

- `A` 键对应的虚拟键码是 `VK_A = 0x41`
- 回车键是 `VK_RETURN = 0x0D`
- 左箭头键是 `VK_LEFT = 0x25`

这些值与你按的是什么字符无关，只和你按了哪个**物理键**有关。

## 二、为什么不能用 `key.char`？

`key.char` 是按键产生的字符，它会受到以下因素影响：

| 影响因素        | 对 `key.char` 的影响 |
|----------------|------------------|
| 输入法          | 按下 `a` 可能变成中文拼音或候选词 |
| CapsLock 状态   | 小写 `a` 变成大写 `A` |
| 键盘布局        | 同一个键在美式键盘是 `Y`，德语键盘可能是 `Z` |
| 组合键（如 AltGr） | 可能输出特殊符号 |

所以如果你想知道“用户是不是按了 **左箭头键**”，而他用的是德语键盘或者正在用输入法打字，那么 `key.char` 很可能无法正确反映他的行为。

## 三、举个例子说明

假设你想检测用户是否按下了 `A` 键：

- 如果你用：

  ```python
  if key.char == 'a':
  ```

  那么只有当按下 `A` 键并输出字符 `'a'` 时才成立。但如果用户：

- 按下了 CapsLock，变成了 `'A'`
- 使用了输入法，比如输入了 “啊”
- 使用的是 AZERTY 键盘，按下的键不是 `'a'`

  上面的判断就失败了。

- 而如果你用：

  ```python
  if key.vk == VK_A:  # 假设 VK_A 是 A 键的虚拟键码
  ```

  不管用户当前是什么键盘布局、有没有开启 CapsLock、有没有使用输入法，只要他按下了那个物理上的 `A` 键，就能正确识别。

## JS 中怎么处理，为什么没遇到过这个问题？

为什么在 **JavaScript 开发中不太容易碰到“输入法干扰、CapsLock 影响、键盘布局不同”等问题”，而**Python 开发中更容易遇到这些麻烦。

### JavaScript 中的键盘事件机制

在浏览器环境中（如 Web 开发），JS 的 `KeyboardEvent` 提供了多个属性，比如：

- `event.key`
- `event.code`
- `event.keyCode` / `event.which`
- `event.charCode`

### JS 推荐使用 `event.code` 来判断物理按键

- `event.code` 表示的是**物理键位**，不受输入法、CapsLock、键盘布局影响。
  - 比如按下了 A 键，不管打出来是 a、A、ā 还是 啊，`event.code === 'KeyA'`
- 所以如果你用 `event.code`，就可以实现类似虚拟键码的功能，和 Python 中使用 `key.vk` 是一样的思路。

### 但 JS 一般不会去监听全局快捷键或做底层控制

- JS 主要运行在浏览器里，权限有限，不能像 Python 那样监听全局按键（比如用户在其他程序中按下 Ctrl+C）。
- 所以在浏览器开发中，你通常只关心当前页面内的交互，输入法处理也是由浏览器统一完成的。
- 即使你在网页里写快捷键，只要你不依赖 `event.key` 而改用 `event.code`，就不会受输入法等干扰。

---

## Python 中为什么更容易碰到这些问题？

Python 作为一门通用编程语言，常用于：

- 编写桌面应用
- 自动化脚本（如自动点击、全局热键）
- 游戏开发（PyGame）
- 系统级工具

在这种场景下，你需要监听用户的**所有按键行为**，甚至包括系统级别的组合键。这时候就不得不面对：

| 场景 | 问题 |
|------|------|
| 使用 `pynput` 或 `keyboard` 库监听按键 | 得到的是字符（`char`）而不是物理键 |
| 用户正在使用中文输入法 | 输入法会拦截按键，导致你无法获取原始键值 |
| 用户换了键盘布局（如德语键盘） | 同一个键可能打出不同的字符 |
| CapsLock 开启 | 小写变大写，判断失败 |

所以，在 Python 中如果不特别注意，很容易因为误用了 `key.char` 而出错。

---

## JS vs Python：对比总结

| 特性 | JavaScript (Web) | Python |
|------|------------------|--------|
| 是否能监听全局按键 | ❌ 不行（受限于浏览器沙盒） | ✅ 可以（通过 pynput、pyHook 等库） |
| 默认监听的事件类型 | 浏览器统一处理输入法、布局 | 直接与操作系统交互 |
| 常用按键属性 | `event.code`（推荐）、`event.key` | `key.char`、`key.vk` |
| 是否受输入法影响 | ❌ 一般不直接受影响（浏览器已处理） | ✅ 容易受影响 |
| 是否受键盘布局影响 | ❌ 用 `code` 不受影响 | ✅ 容易受影响 |
| 典型应用场景 | 快捷键、表单输入 | 自动化、游戏、全局热键 |
